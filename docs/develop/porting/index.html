<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-develop/porting" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">移植到其他平台 | Rasberry Pi DM YT350S006</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://embeddedboys.com/RPi_DM_YT350S006/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://embeddedboys.com/RPi_DM_YT350S006/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://embeddedboys.com/RPi_DM_YT350S006/docs/develop/porting"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="移植到其他平台 | Rasberry Pi DM YT350S006"><meta data-rh="true" name="description" content="image"><meta data-rh="true" property="og:description" content="image"><link data-rh="true" rel="icon" href="/RPi_DM_YT350S006/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://embeddedboys.com/RPi_DM_YT350S006/docs/develop/porting"><link data-rh="true" rel="alternate" href="http://embeddedboys.com/RPi_DM_YT350S006/docs/develop/porting" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="http://embeddedboys.com/RPi_DM_YT350S006/docs/develop/porting" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"进阶开发","item":"http://embeddedboys.com/RPi_DM_YT350S006/docs/category/进阶开发"},{"@type":"ListItem","position":2,"name":"移植到其他平台","item":"http://embeddedboys.com/RPi_DM_YT350S006/docs/develop/porting"}]}</script><link rel="stylesheet" href="/RPi_DM_YT350S006/assets/css/styles.8f9a3374.css">
<script src="/RPi_DM_YT350S006/assets/js/runtime~main.d6545076.js" defer="defer"></script>
<script src="/RPi_DM_YT350S006/assets/js/main.d7a5c46a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RPi_DM_YT350S006/"><div class="navbar__logo"><img src="/RPi_DM_YT350S006/img/logo.svg" alt="embeddedboys Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RPi_DM_YT350S006/img/logo.svg" alt="embeddedboys Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">embeddedboys</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RPi_DM_YT350S006/">首页</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RPi_DM_YT350S006/docs/category/快速上手">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="http://forum.embeddedboys.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">在线论坛<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/RPi_DM_YT350S006/docs/develop/porting" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RPi_DM_YT350S006/docs/category/快速上手">快速上手</a><button aria-label="展开侧边栏分类 &#x27;快速上手&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/RPi_DM_YT350S006/docs/category/进阶开发">进阶开发</a><button aria-label="折叠侧边栏分类 &#x27;进阶开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RPi_DM_YT350S006/docs/develop/note">说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RPi_DM_YT350S006/docs/develop/software">软件构成</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RPi_DM_YT350S006/docs/develop/adapt">适配新屏幕</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RPi_DM_YT350S006/docs/develop/porting">移植到其他平台</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RPi_DM_YT350S006/docs/develop/drm">DRM开发</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RPi_DM_YT350S006/docs/category/diy">DIY</a><button aria-label="展开侧边栏分类 &#x27;DIY&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RPi_DM_YT350S006/docs/category/性能测试">性能测试</a><button aria-label="展开侧边栏分类 &#x27;性能测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RPi_DM_YT350S006/docs/category/关于">关于</a><button aria-label="展开侧边栏分类 &#x27;关于&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/RPi_DM_YT350S006/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/RPi_DM_YT350S006/docs/category/进阶开发"><span>进阶开发</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">移植到其他平台</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>移植到其他平台</h1></header>
<p><img decoding="async" loading="lazy" alt="image" src="/RPi_DM_YT350S006/assets/images/rpi-dm-on-orangepi-one-a1340f1246f9ba0b3884e86270b6f93f.jpg" width="480" height="360" class="img_ev3q"></p>
<p>这里以 <strong>OrangePi-One</strong> 为例，下面是移植时开发板的状态：</p>
<table><thead><tr><th>Device</th><th>OrangePi-One</th></tr></thead><tbody><tr><td>Arch</td><td>arm</td></tr><tr><td>Distro</td><td>Armbian 25.5.2</td></tr><tr><td>Kernel Version</td><td>6.12.30-current-sunxi</td></tr></tbody></table>
<p>本文将分为两部分，前半部分会介绍如何快速部署我们开发的示例到开发板上，后半部分则是移植过程的详细说明。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速部署示例">快速部署示例<a href="#快速部署示例" class="hash-link" aria-label="快速部署示例的直接链接" title="快速部署示例的直接链接">​</a></h2>
<p>先拉取对应仓库，然后来到开发板对应的目录下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/embeddedboys/pico_dm_yt350s006_linux.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd orangepi-one</span><br></span></code></pre></div></div>
<p>编译设备树overlay以及固件，将编译好的文件放置到指定位置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp panel-mipi-dbi.bin /lib/firmware/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp sun8i-h3-spi-st7796u-drm.dtbo /boot/dtb/overlays/</span><br></span></code></pre></div></div>
<p>重启设备，然后手动加载驱动:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo reboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe panel-mipi-dbi</span><br></span></code></pre></div></div>
<p>如果一切顺利，屏幕已经正常显示内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开机自动加载">开机自动加载<a href="#开机自动加载" class="hash-link" aria-label="开机自动加载的直接链接" title="开机自动加载的直接链接">​</a></h3>
<p>由于一些原因，在Armbian系统启动过程中，panel-mipi-dbi 驱动被过早的加载了，早于文件系统的挂载，因此，panel-mipi-dbi 驱动无法正常获取firmware文件（不在initramfs中），所以我们需要将firmware文件打包进initramfs中，下面是操作方法：</p>
<p>将initramfs 打包过程的 hook 脚本放置到指定的位置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp initramfs-hook-panel-mipi-dbi-fw /etc/initramfs-tools/hooks/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo chmod u+x /etc/initramfs-tools/hooks/initramfs-hook-panel-mipi-dbi-fw</span><br></span></code></pre></div></div>
<p>触发initramfs打包流程:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">update-initramfs -u -v</span><br></span></code></pre></div></div>
<p>检查打包后的内容:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@orangepione:~# lsinitramfs /boot/initrd.img-$(uname -r) | grep panel-mipi-dbi-spi.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">usr/lib/firmware/panel-mipi-dbi-spi.bin</span><br></span></code></pre></div></div>
<p>然后重启设备，你可以发现在香橙派的启动过程中，屏幕自动点亮了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="移植过程">移植过程<a href="#移植过程" class="hash-link" aria-label="移植过程的直接链接" title="移植过程的直接链接">​</a></h2>
<p>为什么使用 Armbian 来做演示？</p>
<p>这是因为 Armbian 和 Pi OS 一样使用了 DT overlay 机制，这使得我们可以不编写任何设备  驱动代码，仅靠一些设备树 overlay 文件，在不更改内核代码的情况下，满足大部分的需求。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何编写并应用一个-dt-overlay-文件">如何编写并应用一个 DT overlay 文件<a href="#如何编写并应用一个-dt-overlay-文件" class="hash-link" aria-label="如何编写并应用一个 DT overlay 文件的直接链接" title="如何编写并应用一个 DT overlay 文件的直接链接">​</a></h3>
<p>首先要讲讲如何在 Armbian 上编写并应用一个 设备树 overlay 文件，这里以官方的 one-wire overlay 文件 <code>sun8i-h3-w1-gpio.dts</code> 为例:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">/</span><span class="token plain">dts</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">plugin</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;allwinner,sun8i-h3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 * &amp;pio 是要覆盖的节点，在本案例中，你可以在 sunxi-h3-h5.dtsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 * 这个文件中找到该节点的原型。</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">		 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* 添加的 pinctrl 配置，将 PD14 设置成 GPIO 输入模式*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			w1_pins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> w1_pins </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PD14&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				function </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio_in&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* &quot;/&quot; 表示要操作根节点下的内容 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* 要修改的内容总是放在 __overlay__ 中 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">			 * 这里就按照设备树的语法描述添加需要的节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">			 * 就行了，没有什么需要特殊说明的内容。</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">			 * 这里对应 drivers/w1/masters/w1-gpio.c 驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">			 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			onewire@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;w1-gpio&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">names </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">w1_pins</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* PD14 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>在编写完上述 overlay 文件之后，修改启动配置文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /boot/armbianEnv.txt</span><br></span></code></pre></div></div>
<p>在文件末尾添加以下配置:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">overlays=w1-gpio</span><br></span></code></pre></div></div>
<p>这里需要注意的是，如果有多个overlay，需要用空格分隔开。 这里不需要<code>sun8i-h3</code>前缀的原因是，配置文件中已经指定了<code>overlay_prefix</code>。</p>
<p>重启设备，你可以在 dmesg 中看到，overlay 文件所对应的驱动已经被加载了</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用-panel-mipi-dbi-驱动">如何使用 panel-mipi-dbi 驱动<a href="#如何使用-panel-mipi-dbi-驱动" class="hash-link" aria-label="如何使用 panel-mipi-dbi 驱动的直接链接" title="如何使用 panel-mipi-dbi 驱动的直接链接">​</a></h3>
<p>我们在上一节了解了如何编写一个 overlay 来加载指定驱动，可是问题来了，对于一个陌生的
驱动程序，我们如何知道它需要哪些设备树配置呢？这就需要查阅内核中的 bindings 文档了。</p>
<p>你可以在内核代码的 <code>Documentation/devicetree/bindings</code> 目录下找到大部分驱动的设备树节点配置示例，panel-mipi-dbi 驱动的示例位于 <code>Documentation/devicetree/bindings/display/panel/panel-mipi-dbi-spi.yaml</code>，限于篇幅，我只在下面展示关键的部分：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;dt-bindings/gpio/gpio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">address</span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression" style="color:#36acaa">cells </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">size</span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression" style="color:#36acaa">cells </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display@</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sainsmart18&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;panel-mipi-dbi-spi&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            spi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">max</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">frequency </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">40000000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gpio </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> GPIO_ACTIVE_HIGH</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gpio </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> GPIO_ACTIVE_HIGH</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            write</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">only</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            backlight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">backlight</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            width</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">35</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            height</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">28</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">timing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hactive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">160</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vactive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">128</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hback</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vback</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                clock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">frequency </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hfront</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hsync</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vfront</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vsync</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>现在，我们来仿照上面的配置创建 overlay，下面是 overlay 文件的内容:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">/</span><span class="token plain">dts</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">plugin</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;allwinner,sun8i-h3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			tft_pins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tft_pins </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PA2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PA3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				function </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio_out&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">spi0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			tft</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> st7796u@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">address</span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression" style="color:#36acaa">cells </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">size</span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression" style="color:#36acaa">cells </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">names </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">tft_pins</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;panel-mipi-dbi-spi&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				spi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">max</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">frequency </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">100000000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				reg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				width</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">55</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				height</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">84</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				reset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				dc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				write</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">only</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">timing </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					hactive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">480</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					vactive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">320</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					hback</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					vback</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					clock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">frequency </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					hfront</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					hsync</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					vfront</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">porch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					vsync</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>我们把这个文件保存为 <code>sun8i-h3-spi-st7796u-drm.dts</code>，然后编译成二进制：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dtc -@ -I dts -O dtb -o sun8i-h3-spi-st7796u-drm.dtbo sun8i-h3-spi-st7796u-drm.dts</span><br></span></code></pre></div></div>
<p>讲这个文件拷贝到 <code>/boot/dtb/overlay</code> 文件夹下，修改 <code>/boot/armbianEnv.txt</code>，添加overlay配置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp sun8i-h3-spi-st7796u-drm.dtbo /boot/dtb/overlay/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /boot/armbianEnv.txt</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">overlays=spi-st7796u-drm</span><br></span></code></pre></div></div>
<p>配置完成后，重启设备后，查看内核日志，你会发现如下报错：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">3.350494</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi spi0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Direct firmware load </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bin failed with error </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">3.350538</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi spi0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Falling back to sysfs fallback </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">64.499684</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi spi0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> No config file found </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> compatible </span><span class="token char">&#x27;panel-mipi-dbi-spi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">110</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">64.499725</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi spi0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> probe with driver panel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mipi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dbi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spi failed with error </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">110</span><br></span></code></pre></div></div>
<p>这是因为驱动没有找到有效的 firmware 文件，下面我们来介绍如何为 panel-mipi-dbi 驱动制作 firmware。</p>
<p>首先，你需要 <code>mipi-dbi-cmd</code> 这个工具，你可以在驱动作者的这个仓库中找到 <a href="https://github.com/notro/panel-mipi-dbi/blob/main/mipi-dbi-cmd" target="_blank" rel="noopener noreferrer">mipi-dbi-cmd</a>，它是一个python脚本，把它下载到本地，添加可执行权限就可以了。</p>
<p>这是一个 firmware 的源文件示例, <code>rpi-dm-hp35006.txt</code> ：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xC3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x96</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x36</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x3A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x55</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xB4</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xB1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xB5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1F</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x50</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xB6</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x8A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x07</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3B</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xC0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xC1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x13</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xC2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xA7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xC5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x09</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xE8</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x8a</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x19</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xA5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xE0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x06</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0B</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x07</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x06</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2E</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x33</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x47</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x17</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x16</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2E</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xE1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x09</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0D</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x09</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2E</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x33</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x46</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x38</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x13</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x13</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2C</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3C</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0xF0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x69</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x35</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x11</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delay </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x29</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delay </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command </span><span class="token number" style="color:#36acaa">0x21</span><br></span></code></pre></div></div>
<p>寄存器操作以 <code>command</code> 命令开头，后面紧跟的是寄存器地址，在此之后的都是参数</p>
<p>延时操作以 <code>delay</code> 命令开头，后面紧跟的是毫秒数</p>
<p>编写完成后，使用 <code>mipi-dbi-cmd</code> 工具将其转成bin文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./mipi-dbi-cmd panel-mipi-dbi.bin rpi-dm-hp35006.txt</span><br></span></code></pre></div></div>
<p>将 <code>panel-mipi-dbi.bin</code> 文件拷贝到 <code>/lib/firmware</code> 文件夹中，重新加载驱动，查看日志，你会发现驱动已经成功加载了：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe panel-mipi-dbi-spi</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">developer@orangepione:~$ dmesg | grep panel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    3.343660] panel-mipi-dbi-spi spi0.0: supply power not found, using dummy regulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    3.344113] panel-mipi-dbi-spi spi0.0: supply io not found, using dummy regulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    3.378360] [drm] Initialized panel-mipi-dbi 1.0.0 for spi0.0 on minor 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    3.868253] panel-mipi-dbi-spi spi0.0: [drm] fb0: panel-mipi-dbid frame buffer device</span><br></span></code></pre></div></div>
<p>但是屏幕仍然黑屏，这是因为没有开启背光导致的，现在，你可以通过 gpio sysfs 手动操作背光引脚来点亮背光，本案例中背光引脚为 PD14 ，对应编号 110，全志平台每32个gpio为一组：</p>
<p>PD14 = 32 * 3 + 14 = 110</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 110 &gt; /sys/class/gpio/export</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo out &gt; /sys/class/gpio/gpio110/direction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo 1 &gt; /sys/class/gpio/gpio110/value</span><br></span></code></pre></div></div>
<p>在执行完上述命令后，背光被激活，屏幕显示了内容。</p>
<p>但是如何让其自动完成呢？为什么前面的panel-mipi-dbi的设备树节点没有背光配置？我们会在下一节描述这个问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="屏幕的背光是个大问题">屏幕的背光是个大问题<a href="#屏幕的背光是个大问题" class="hash-link" aria-label="屏幕的背光是个大问题的直接链接" title="屏幕的背光是个大问题的直接链接">​</a></h3>
<p>在上一节中，我们已经成功驱动了屏幕，可是屏幕还是没有亮，这是因为没有打开屏幕的背光，那如何在屏幕驱动加载时自动开启背光呢？</p>
<p>通常情况下，我们会在panel-mipi-dbi的设备树节点中添加这么一行配置：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">backlight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">backlight</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这个 <code>&amp;backlight</code> 是在哪个节点中定义的呢？在绝大多数平台上，可以简单地这么编写设备树节点：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">backlight </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio-backlight&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gpio3 </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> GPIO_ACTIVE_HIGH</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">on</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这将把 gpio3 的 4 号引脚作为背光的控制引脚，不 过功能较为简单，只能控制开启和关闭。</p>
<p>为什么在 OrangePi-One 的 Armbian 上无法使用？我在这个背光的适配过程遇到了很多问题，让我们来逐个分析。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-系统中缺少-gpio-backlight-驱动的-ko-文件">1. 系统中缺少 gpio-backlight 驱动的 ko 文件<a href="#1-系统中缺少-gpio-backlight-驱动的-ko-文件" class="hash-link" aria-label="1. 系统中缺少 gpio-backlight 驱动的 ko 文件的直接链接" title="1. 系统中缺少 gpio-backlight 驱动的 ko 文件的直接链接">​</a></h4>
<p>在树莓派上，这个驱动位于 <code>/lib/modules/$(uname -r)/kernel/drivers/video/backlight/gpio-backlight.ko</code>。 但是我没有在 OrangePi-One 上找到这个驱动文件，同时我尝试了在 dt overlay 文件中调用这个驱动，没有起效，说明这个驱动没有被编译到系统或者内核中去。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-系统中有-pwm-backlight-驱动但是-pd14-引脚没有-pwm-功能">2. 系统中有 pwm-backlight 驱动，但是 PD14 引脚没有 PWM 功能<a href="#2-系统中有-pwm-backlight-驱动但是-pd14-引脚没有-pwm-功能" class="hash-link" aria-label="2. 系统中有 pwm-backlight 驱动，但是 PD14 引脚没有 PWM 功能的直接链接" title="2. 系统中有 pwm-backlight 驱动，但是 PD14 引脚没有 PWM 功能的直接链接">​</a></h4>
<p><code>drivers/pinctrl/sunxi/pinctrl-sun8i-h3.c</code></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sunxi_desc_pin</span><span class="token plain"> sun8i_h3_pins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">SUNXI_PIN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">SUNXI_PINCTRL_PIN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">D</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		  </span><span class="token function" style="color:#d73a49">SUNXI_FUNCTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio_in&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		  </span><span class="token function" style="color:#d73a49">SUNXI_FUNCTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio_out&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		  </span><span class="token function" style="color:#d73a49">SUNXI_FUNCTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;emac&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* TXERR */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>那么最后我是如何解决这个问题的？好吧，如你所见，我尝试了一些方法，但是都不能实现在屏幕驱动加载时自动开启背光。</p>
<p>所以我调转了思路，在启动时，驱动加载前自动将背光点亮。 虽然不够优雅，但是起码可以正常工作。 我尝试了一些方法，但还是遇到了一些问题，不过最后还是解决了，下面来逐个分析：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-gpio-hog-配置可以让某个指定引脚在-gpiochip-加载时设置一个固定状态">3. gpio-hog 配置可以让某个指定引脚在 gpiochip 加载时设置一个固定状态<a href="#3-gpio-hog-配置可以让某个指定引脚在-gpiochip-加载时设置一个固定状态" class="hash-link" aria-label="3. gpio-hog 配置可以让某个指定引脚在 gpiochip 加载时设置一个固定状态的直接链接" title="3. gpio-hog 配置可以让某个指定引脚在 gpiochip 加载时设置一个固定状态的直接链接">​</a></h4>
<p>查看内核文档 <a href="https://www.kernel.org/doc/Documentation/devicetree/bindings/gpio/gpio.txt" target="_blank" rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/devicetree/bindings/gpio/gpio.txt</a> 有如下内容：</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The GPIO chip may contain GPIO hog definitions. GPIO hogging is a mechanism</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">providing automatic GPIO request and configuration as part of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpio-controller&#x27;s driver probe function.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Each GPIO hog definition is represented as a child node of the GPIO controller.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Required properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gpio-hog:   A property specifying that this child node represents a GPIO hog.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gpios:      Store the GPIO information (id, flags, ...) for each GPIO to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	      affect. Shall contain an integer multiple of the number of cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	      specified in its parent node (GPIO controller node).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Only one of the following properties scanned in the order shown below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This means that when multiple properties are present they will be searched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in the order presented below and the first match is taken as the intended</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- input:      A property specifying to set the GPIO direction as input.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- output-low  A property specifying to set the GPIO direction as output with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	      the value low.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- output-high A property specifying to set the GPIO direction as output with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	      the value high.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- line-name:  The GPIO label name. If not present the node name is used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Example of two SOC GPIO banks defined as gpio-controller nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	qe_pio_a: gpio-controller@1400 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		compatible = &quot;fsl,qe-pario-bank-a&quot;, &quot;fsl,qe-pario-bank&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		reg = &lt;0x1400 0x18&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		gpio-controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		#gpio-cells = &lt;2&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		line_b-hog {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			gpio-hog;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			gpios = &lt;6 0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			output-low;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			line-name = &quot;foo-bar-gpio&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	qe_pio_e: gpio-controller@1460 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		compatible = &quot;fsl,qe-pario-bank-e&quot;, &quot;fsl,qe-pario-bank&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		reg = &lt;0x1460 0x18&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		gpio-controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		#gpio-cells = &lt;2&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	};</span><br></span></code></pre></div></div>
<p>我根据文档中的示例配置了一个hog节点：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			bl_hog </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				gpio</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hog</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				output</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				line</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;display-backlight&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>但这没有效果，重启后我没有在内核日志中看到任何与hog相关的内容，翻阅源码，有关
gpio-hog 的处理位于 <code>of_gpiochip_scan_gpios</code> 函数中 <code>drivers/gpio/gpiolib-of.c</code>，
如果gpio-hog被成功配置，那么在<code>drivers/gpio/gpiolib.c#L4182</code> 有如下日志逻辑：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gpiod_hog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">gpio_desc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	      </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> lflags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">gpiod_flags</span><span class="token plain"> dflags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">gpiod_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hogged as %s%s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dflags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> GPIOD_FLAGS_BIT_DIR_OUT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;output&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;input&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dflags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> GPIOD_FLAGS_BIT_DIR_OUT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dflags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> GPIOD_FLAGS_BIT_DIR_VAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/high&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/low&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>我google了相关问题，还有了些意外收获，树莓派的pinctrl驱动在早期版本因为pinctrl和gpiochip注册顺序问 题导致了 gpio-hog 没有被正常处理，可以到如下树莓派论坛查看原贴内容</p>
<p><a href="https://forums.raspberrypi.com/viewtopic.php?t=260600" target="_blank" rel="noopener noreferrer">https://forums.raspberrypi.com/viewtopic.php?t=260600</a></p>
<p>以及相关的PR：</p>
<p><a href="https://github.com/raspberrypi/linux/pull/3394" target="_blank" rel="noopener noreferrer">https://github.com/raspberrypi/linux/pull/3394</a></p>
<p>修改内容大致上是将 pinctrl 驱动的注册放到了 gpiochip 之前，产生这种问题的原因主要是现在大部分处理器的pinctrl驱动都是将 pinctrl 和 gpiochip 驱动混合在一起编写。</p>
<p>所以我查看了全志平台的 pinctrl 驱动，发现它并没有这个注册顺序问题，我不知所措了：</p>
<p><code>drivers/pinctrl/sunxi/pinctrl-sunxi.c</code></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sunxi_pinctrl_init_with_variant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">platform_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pdev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sunxi_pinctrl_desc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> variant</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pctl_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">devm_pinctrl_register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pctrl_desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pctl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">IS_ERR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pctl_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">dev_err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;couldn&#x27;t register pinctrl driver\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PTR_ERR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pctl_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">devm_kzalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GFP_KERNEL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	last_pin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">npins </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> THIS_MODULE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpiochip_generic_request</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">free </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpiochip_generic_free</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">set_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpiochip_generic_config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">direction_input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_direction_input</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">direction_output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_direction_output</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">get </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">set </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_set</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">of_xlate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_of_xlate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">to_irq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sunxi_pinctrl_gpio_to_irq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">of_gpio_n_cells </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">can_sleep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ngpio </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">round_up</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">last_pin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PINS_PER_BANK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			    pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pin_base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dev_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">parent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">base </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pin_base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gpiochip_add_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pctl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">npins</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sunxi_desc_pin</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pins </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gpiochip_add_pin_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">chip</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dev_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					     pin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> pctl</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pin_base</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					     pin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> gpiochip_error</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>我不知道这是不是由于缺少了 <code>pinctrl_add_gpio_range</code> 调用的缘故，你可以看到树莓派的 pinctrl 驱动（<code>drivers/pinctrl/bcm/pinctrl-bcm2835.c</code>）这么做了，全志的 pinctrl 驱动则使用了 <code>gpiochip_add_pin_range</code>。</p>
<p>总之我没有让 <code>gpio-hog</code> 在这个平台上成功启用，我不是 pinctrl 与 gpio 驱动的专家，且由于修改内核代码不是很方便，你需要拉取 armbian 的 build 仓库构建，操作起来类似于buildroot。</p>
<p>我相信这个问题肯定能够解决，可能会产生新的patch。不过我暂时没有太多精力能放在这上面，所以我也就没有继续研究下去了。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-取巧的方法通过-gpio-leds-驱动点亮背光">4. 取巧的方法，通过 gpio-leds 驱动点亮背光<a href="#4-取巧的方法通过-gpio-leds-驱动点亮背光" class="hash-link" aria-label="4. 取巧的方法，通过 gpio-leds 驱动点亮背光的直接链接" title="4. 取巧的方法，通过 gpio-leds 驱动点亮背光的直接链接">​</a></h4>
<p>我在翻看 OrangePi-One 的设备树文件时，发现了一些状态灯的配置：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	leds </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio-leds&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pwr_led </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;orangepi:green:pwr&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">r_pio </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> GPIO_ACTIVE_HIGH</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;on&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		status_led </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;orangepi:red:status&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> GPIO_ACTIVE_HIGH</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这个 <code>pwr_led</code> 位于 OrangePi-One 正面的 gpio 接口旁，绿色灯光，鉴于它连接到了某个gpio引脚，所以它是正常工作的。 但是我没有在 <code>/lib/modules/$(uname -r)/kernel/drivers/leds</code> 下找到这个驱动，这说明它被编译进了内核中。</p>
<p>所以我仿照它编写了一个背光灯配置节点，结果很成功。 不过屏幕背光被过早地开启了。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	fragment@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			bl_leds </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gpio-leds&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">names </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				pinctrl</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bl_pins</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				bl_led0 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;display:backlight&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					gpios </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pio </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;on&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="让触摸屏工作起来">让触摸屏工作起来<a href="#让触摸屏工作起来" class="hash-link" aria-label="让触摸屏工作起来的直接链接" title="让触摸屏工作起来的直接链接">​</a></h3>
<p>Still under development</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="#参考资料" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<p><a href="https://github.com/notro/panel-mipi-dbi/wiki" target="_blank" rel="noopener noreferrer">https://github.com/notro/panel-mipi-dbi/wiki</a></p>
<p><a href="https://github.com/armbian/sunxi-DT-overlays/blob/master/sun8i-h3/sun8i-h3-w1-gpio.dts" target="_blank" rel="noopener noreferrer">https://github.com/armbian/sunxi-DT-overlays/blob/master/sun8i-h3/sun8i-h3-w1-gpio.dts</a></p>
<p><a href="https://elixir.bootlin.com/linux/v6.1.99/source/arch/arm/boot/dts/sun8i-h3-orangepi-one.dts" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/arch/arm/boot/dts/sun8i-h3-orangepi-one.dts</a>
<a href="https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpu/drm/drm_mipi_dbi.c" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpu/drm/drm_mipi_dbi.c</a>
<a href="https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpu/drm/tiny/panel-mipi-dbi.c" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpu/drm/tiny/panel-mipi-dbi.c</a>
<a href="https://elixir.bootlin.com/linux/v6.1.99/source/drivers/pinctrl/sunxi/pinctrl-sunxi.c" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/drivers/pinctrl/sunxi/pinctrl-sunxi.c</a>
<a href="https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpio/gpiolib-of.c" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpio/gpiolib-of.c</a>
<a href="https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpio/gpiolib.c#L4182" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v6.1.99/source/drivers/gpio/gpiolib.c#L4182</a></p>
<p><a href="https://www.kernel.org/doc/Documentation/devicetree/bindings/gpio/gpio.txt" target="_blank" rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/devicetree/bindings/gpio/gpio.txt</a></p>
<p><a href="https://forums.raspberrypi.com/viewtopic.php?t=260600" target="_blank" rel="noopener noreferrer">Problem with gpio-hog</a></p>
<p><a href="https://github.com/raspberrypi/linux/pull/3394" target="_blank" rel="noopener noreferrer">pinctrl: bcm2835: Change init order for gpio hogs</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/develop/porting.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RPi_DM_YT350S006/docs/develop/adapt"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">适配新屏幕</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RPi_DM_YT350S006/docs/develop/drm"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">DRM开发</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#快速部署示例" class="table-of-contents__link toc-highlight">快速部署示例</a><ul><li><a href="#开机自动加载" class="table-of-contents__link toc-highlight">开机自动加载</a></li></ul></li><li><a href="#移植过程" class="table-of-contents__link toc-highlight">移植过程</a><ul><li><a href="#如何编写并应用一个-dt-overlay-文件" class="table-of-contents__link toc-highlight">如何编写并应用一个 DT overlay 文件</a></li><li><a href="#如何使用-panel-mipi-dbi-驱动" class="table-of-contents__link toc-highlight">如何使用 panel-mipi-dbi 驱动</a></li><li><a href="#屏幕的背光是个大问题" class="table-of-contents__link toc-highlight">屏幕的背光是个大问题</a></li><li><a href="#让触摸屏工作起来" class="table-of-contents__link toc-highlight">让触摸屏工作起来</a></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://forum.embeddedboys.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">官方论坛<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我们</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/1380422187" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 embeddedboys. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>